# ContestTrade 项目架构图

## 🏗️ 整体架构概览

```mermaid
graph TD
    %% 用户界面层
    CLI[CLI 命令行界面<br/>typer + rich] --> STC[SimpleTradeCompany<br/>主控制器]
    
    %% 主工作流引擎
    STC --> WF[LangGraph 工作流引擎]
    
    %% 四个主要阶段
    WF --> DAA[Data Analysis Agents<br/>数据分析智能体]
    WF --> RA[Research Agents<br/>研究分析智能体] 
    WF --> JC[Judger Critic<br/>评判器（可选）]
    WF --> CS[Contest System<br/>竞赛系统]
    
    %% 数据分析智能体详细结构
    DAA --> DS1[Sina News Agent<br/>新浪财经数据]
    DAA --> DS2[THX News Agent<br/>同花顺数据]
    DAA --> DS3[Price Market Agent<br/>价格数据]
    DAA --> DS4[Hot Money Agent<br/>游资数据]
    DAA --> DS5[Community Sentiment Agent<br/>社区情绪数据]
    
    %% 社区数据源详细结构
    DS5 --> CS1[雪球社区爬虫<br/>XueqiuCommunityCrawl]
    DS5 --> CS2[东方财富股吧<br/>EastmoneyCommunityCrawl]
    
    CS1 --> SENTI1[KOL观点追踪<br/>影响力分析]
    CS2 --> SENTI2[散户情绪捕获<br/>热度分析]
    
    %% 研究智能体详细结构  
    RA --> RAGENT1[Research Agent 0<br/>基于信念1]
    RA --> RAGENT2[Research Agent 1<br/>基于信念2]
    RA --> RAGENT3[Research Agent N<br/>基于信念N]
    
    %% 工具系统
    RAGENT1 --> TOOLS[工具系统<br/>Tools System]
    RAGENT2 --> TOOLS
    RAGENT3 --> TOOLS
    
    TOOLS --> TOOL1[股票搜索工具]
    TOOLS --> TOOL2[价格信息工具]
    TOOLS --> TOOL3[公司信息工具]
    TOOLS --> TOOL4[网络搜索工具]
    TOOLS --> TOOL5[股票选择工具]
    TOOLS --> TOOL6[股票摘要工具]
    
    %% 数据源系统
    DS1 --> AKSHARE[AKShare 数据源]
    DS2 --> AKSHARE
    DS3 --> AKSHARE
    DS4 --> AKSHARE
    
    AKSHARE --> CACHE[数据缓存系统]
    
    %% LLM 模型层
    DAA --> LLM[LLM 模型层]
    RA --> LLM
    JC --> LLM
    
    LLM --> DEEPSEEK[DeepSeek API<br/>通用任务]
    LLM --> REASONER[DeepSeek Reasoner<br/>复杂推理]
    LLM --> VLM[StepFun VLM<br/>视觉分析]
    
    %% 输出系统
    CS --> REPORT[报告生成系统]
    REPORT --> MDREPORT[Markdown 报告]
    REPORT --> TERMINAL[终端交互报告]
    
    %% 配置系统
    CONFIG[配置系统<br/>config.yaml] --> STC
    CONFIG --> DAA
    CONFIG --> RA
    
    %% 工作区文件系统
    STC --> WORKSPACE[工作区文件系统<br/>agents_workspace]
    WORKSPACE --> FACTORS[factors/<br/>数据分析结果]
    WORKSPACE --> REPORTS[reports/<br/>研究报告]
    WORKSPACE --> LOGS[logs/<br/>运行日志]
    WORKSPACE --> RESULTS[results/<br/>最终报告]
```

## 🔄 数据流程图

```mermaid
sequenceDiagram
    participant U as 用户
    participant CLI as CLI界面
    participant STC as SimpleTradeCompany
    participant DAA as Data Analysis Agents
    participant RA as Research Agents
    participant JC as Judger Critic
    participant CS as Contest System
    participant R as 报告生成
    
    U->>CLI: contesttrade run
    CLI->>STC: 创建公司实例
    
    Note over STC: LangGraph 工作流启动
    
    %% 数据分析阶段
    STC->>DAA: 并发启动数据分析智能体
    par Sina News Agent
        DAA->>DAA: 获取新浪财经数据
    and THX News Agent  
        DAA->>DAA: 获取同花顺数据
    and Price Market Agent
        DAA->>DAA: 获取价格市场数据
    and Hot Money Agent
        DAA->>DAA: 获取游资数据
    end
    DAA-->>STC: 返回数据因子
    
    %% 研究分析阶段
    STC->>RA: 基于数据因子启动研究智能体
    par Research Agent 0
        RA->>RA: 基于信念1分析投资机会
    and Research Agent 1
        RA->>RA: 基于信念2分析投资机会
    and Research Agent N
        RA->>RA: 基于信念N分析投资机会
    end
    RA-->>STC: 返回投资信号
    
    %% 评判阶段（可选）
    alt 竞赛模式开启
        STC->>JC: 评判各智能体表现
        JC-->>STC: 返回评分和权重
    end
    
    %% 竞赛阶段
    STC->>CS: 基于权重选择最佳信号
    CS-->>STC: 返回最终投资信号
    
    %% 报告生成
    STC->>R: 生成分析报告
    R-->>CLI: 返回交互式报告
    CLI-->>U: 展示结果
```

## 🏢 核心组件架构

### 1. 主控制层 (Control Layer)
```
SimpleTradeCompany (主控制器)
├── LangGraph 工作流引擎
├── 状态管理 (CompanyState)
├── 事件处理系统
└── 异步并发控制
```

### 2. 智能体层 (Agent Layer)

#### Data Analysis Agents (数据分析智能体)
```
DataAnalysisAgent
├── 数据源管理
│   ├── SinaNewsCrawl (新浪财经)
│   ├── ThxNewsCrawl (同花顺)
│   ├── PriceMarketAkshare (价格数据)
│   └── HotMoneyAkshare (游资数据)
├── 批处理系统
├── LLM 智能过滤
├── 内容深度摘要
└── 多批次合并
```

#### Research Agents (研究分析智能体)
```
ResearchAgent
├── 信念系统 (Belief System)
├── ReACT 推理模式
├── 工具调用系统
│   ├── 股票搜索工具
│   ├── 价格信息工具
│   ├── 公司信息工具
│   ├── 网络搜索工具
│   ├── 股票选择工具
│   └── 股票摘要工具
└── 投资信号生成
```

### 3. 数据层 (Data Layer)
```
数据层架构
├── AKShare 数据接口
├── 多级缓存系统
│   ├── 内存缓存
│   ├── 文件缓存 (.pkl)
│   └── 数据库缓存 (JSON)
├── 市场管理器
│   ├── 股票基础信息
│   ├── 交易日历
│   └── 指数成分股
└── 数据提供者
    ├── Tushare (可选)
    ├── FMP (可选)
    └── Finnhub (可选)
```

### 4. 模型层 (Model Layer)
```
LLM 模型系统
├── 通用 LLM
│   ├── DeepSeek Chat
│   └── 文本生成任务
├── 思考 LLM  
│   ├── DeepSeek Reasoner
│   └── 复杂推理任务
└── 视觉 LLM
    ├── StepFun Vision
    └── 图像分析任务
```

### 5. 工具层 (Tools Layer)
```
工具管理系统
├── 股票符号搜索
├── 股票价格查询
├── 公司基本面信息
├── 网络搜索引擎
├── 股票筛选器
├── 股票摘要生成
└── 最终报告生成
```

### 6. 输出层 (Output Layer)
```
报告生成系统
├── Markdown 报告
├── 终端交互式报告
├── Rich 格式化输出
└── 实时状态显示
```

## 🔧 技术栈

### 核心框架
- **LangGraph**: 工作流编排引擎
- **LangChain**: LLM 应用框架
- **Typer**: CLI 命令行框架
- **Rich**: 终端美化库

### 数据处理
- **AKShare**: 金融数据获取
- **Pandas**: 数据处理
- **Pickle**: 数据缓存

### AI 模型
- **DeepSeek API**: 主要 LLM 服务
- **StepFun API**: 视觉模型服务

### 配置管理
- **YAML**: 配置文件格式
- **Pydantic**: 数据验证

## 📁 目录结构映射

```
contsttrade/
├── cli/                    # CLI 界面层
├── contest_trade/          # 核心业务逻辑
│   ├── agents/            # 智能体实现
│   ├── config/            # 配置管理
│   ├── contest/           # 竞赛系统
│   ├── data_source/       # 数据源管理
│   ├── models/            # 模型层
│   ├── tools/             # 工具系统
│   └── utils/             # 工具函数
├── agents_workspace/       # 工作区
│   ├── factors/           # 数据分析结果
│   ├── reports/           # 研究报告
│   ├── logs/              # 运行日志
│   └── results/           # 最终报告
└── config.yaml            # 主配置文件
```

## 🎭 社区情绪分析流程

```mermaid
graph TD
    %% 社区数据获取流程
    START[开始社区数据分析] --> FETCH[并发获取社区数据]
    
    %% 数据源并发获取
    FETCH --> XQ[雪球社区爬虫]
    FETCH --> EM[东方财富股吧]
    
    %% 雪球数据处理
    XQ --> XQ1[获取热门时间线]
    XQ --> XQ2[筛选KOL用户]
    XQ --> XQ3[分析影响力分数]
    XQ1 --> XQPROCESS[雪球数据处理]
    XQ2 --> XQPROCESS
    XQ3 --> XQPROCESS
    
    %% 东方财富数据处理
    EM --> EM1[获取热门股票列表]
    EM --> EM2[抓取股吧讨论]
    EM --> EM3[分析帖子热度]
    EM1 --> EMPROCESS[东财数据处理]
    EM2 --> EMPROCESS  
    EM3 --> EMPROCESS
    
    %% 情绪分析处理
    XQPROCESS --> SENTIMENT[情绪分析引擎]
    EMPROCESS --> SENTIMENT
    
    SENTIMENT --> S1[情绪倾向识别<br/>看多/看空/中性]
    SENTIMENT --> S2[情绪强度计算<br/>恐慌/贪婪指数]
    SENTIMENT --> S3[话题热度分析<br/>催化剂事件识别]
    SENTIMENT --> S4[KOL观点追踪<br/>意见领袖态度]
    
    %% 综合分析
    S1 --> ANALYSIS[社区情绪综合分析]
    S2 --> ANALYSIS
    S3 --> ANALYSIS
    S4 --> ANALYSIS
    
    %% 输出结果
    ANALYSIS --> OUTPUT1[情绪指标报告]
    ANALYSIS --> OUTPUT2[热点话题清单]
    ANALYSIS --> OUTPUT3[KOL观点摘要]
    ANALYSIS --> OUTPUT4[投资者行为分析]
    
    %% 最终整合
    OUTPUT1 --> FINAL[社区情绪因子]
    OUTPUT2 --> FINAL
    OUTPUT3 --> FINAL
    OUTPUT4 --> FINAL
    
    FINAL --> END[传递给研究智能体]
```

## 🎯 特色架构亮点

1. **多智能体并发架构**: 支持多个智能体同时工作，提高分析效率
2. **基于信念的研究系统**: 每个研究智能体基于不同的投资理念进行分析
3. **LangGraph 工作流引擎**: 提供可视化的状态管理和流程控制
4. **多级缓存系统**: 减少 API 调用，提高系统性能
5. **实时交互界面**: Rich 库提供美观的终端界面体验
6. **竞赛机制**: 通过内部竞赛选择最优投资信号
7. **模块化设计**: 高度解耦的组件设计，易于扩展和维护
8. **🆕 社区情绪感知**: 集成雪球、东方财富等社区数据，捕获市场情绪
9. **🆕 KOL观点追踪**: 自动识别和分析有影响力用户的投资观点
10. **🆕 催化剂事件识别**: 从社区讨论中挖掘潜在的市场催化剂

## 🔥 社区数据源特色功能

### 雪球社区爬虫 (XueqiuCommunityCrawl)
- **KOL识别**: 基于粉丝数和互动量筛选高影响力用户
- **情绪分析**: 自动识别看多/看空情绪及强度
- **股票提及**: 智能提取讨论的股票代码
- **影响力评分**: 综合粉丝数、点赞、评论计算影响力

### 东方财富股吧爬虫 (EastmoneyCommunityCrawl)  
- **热门股票追踪**: 自动获取当前热门讨论股票
- **散户情绪**: 捕获普通投资者的真实想法
- **恐慌/贪婪指数**: 量化市场情绪极端程度
- **话题热度分析**: 识别讨论量激增的主题

### 智能情绪分析
- **多层次情绪识别**: 强烈看多/温和看多/中性/温和看空/强烈看空
- **情绪拐点检测**: 识别情绪从极端回归理性的信号
- **反向指标**: 当散户情绪过于一致时提供反向投资参考

这个架构设计体现了现代 AI 应用的最佳实践，将多智能体系统、工作流引擎、传统金融数据和社区情绪数据完美结合，为投资决策提供更全面的信息维度。